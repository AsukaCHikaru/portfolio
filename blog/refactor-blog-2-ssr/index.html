<!doctype html>
<html lang="en">
  <head>
    <title>Refactor Blog: (2) SSR | Asuka Wang</title>
    <meta name="description" content="After the Webpack setup for this site, I also implemented server-side-rendering from scratch.">
    <meta name="author" content="Asuka Wang">
    <meta property="og:title" content="Refactor Blog: (2) SSR | Asuka Wang">
    <meta property="og:description" content="After the Webpack setup for this site, I also implemented server-side-rendering from scratch.">
  
    <meta charset="utf-8" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1" />
    <script type="module" src="/index.js" async></script>
    <link rel="stylesheet" href="/fonts.css" />
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/modern-normalize.css" />
    <link
      rel="preload"
      href="/fonts/CormorantGaramond-Regular.subset.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_extended_latin_NotoSerifJP_Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_extended_latin_NotoSerifJP_ExtraLight.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_latin_NotoSerifJP_Bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_latin_NotoSans_ExtraLight.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_latin_NotoSans_Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_extended_latin_GentiumBookPlus_Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_extended_latin_GentiumBookPlus_Bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      href="/fonts/subset_extended_latin_GentiumPlus_Italic.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />
  <script>window.__STATIC_PROPS__ = {"blog":{"post":{"metadata":{"title":"Refactor Blog: (2) SSR","description":"After the Webpack setup for this site, I also implemented server-side-rendering from scratch.","publishedAt":"2021-03-26","pathname":"refactor-blog-2-ssr","category":"retrospective","topic":"web development","language":"en-US","featured":false},"content":[{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"One of the reasons I choose Gatsby last time I wrote my blog site is to have SSR. SEO matters, isn't it?"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"I gained experience setting up SSR in my job, and this is how I apply that experience in my project."}]},{"type":"heading","level":1,"body":[{"type":"textBody","style":"plain","value":"The Idea"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"First, let's talk about React (and most of the MVVM frameworks) app without SSR. They are an HTML template with a js file. Everything about the app is in the js file; the HTML is merely a host for the app."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"When the user's browser requests data of the app from the server, the HTML is provided. A blank HTML page with some metadata is rendered."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Then the HTML requests the data of the js file from the "},{"type":"textBody","style":"code","value":"\u003cscript\u003e"},{"type":"textBody","style":"plain","value":" tag. The js file is fetched then executed. The logic inside starts working. Then the app is created and attached to a specific HTML element."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"The problem is that search engines can't observe the actual app in the first render. Therefore, for the search engines, the app is always a blank page."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"The solution is SSR -- server-side rendering. When the app is requested, the server runs the app, prints them into strings, then sends them with the HTML. For the browsers or the search engines, they get the whole app in the first render."}]},{"type":"heading","level":1,"body":[{"type":"textBody","style":"plain","value":"Dependencies"}]},{"type":"list","ordered":false,"items":[{"type":"listItem","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"express"}],"url":"http://expressjs.com/"},{"type":"textBody","style":"plain","value":" for handling requests and responses"}]}]},{"type":"heading","level":1,"body":[{"type":"textBody","style":"plain","value":"Setting up the server"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Receive requests and send HTML. The HTML will be a string instead of a file for inserting stringified app."}]},{"type":"code","lang":"ts","body":"import * as Express from \"express\";\n\nconst APP_PORT = process.env.PORT || 3000;\nconst app = Express();\nconst renderer = () =\u003e {\n  app.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n    res.send(`\n\t\t\t\u003c!DOCTYPE HTML\u003e\n\t\t\t\u003chtml\u003e\n\t\t\t\t\u003chead\u003e\n\t\t\t\t\t\u003c!-- insert metadata here --\u003e\n\t\t\t\t\u003c/head\u003e\n\t\t\t\t\u003cbody\u003e\n\t\t\t\t\t\u003cdiv id=\"app-root\"\u003e\u003c/div\u003e\n\t\t\t\t\u003c/body\u003e\n\t\t\t\u003c/html\u003e\n\t\t`);\n  });\n};\n\napp.use(renderer);\napp.listen(APP_PORT, () =\u003e {\n  console.log(`Server is listening on ${APP_PORT}`);\n});"},{"type":"heading","level":1,"body":[{"type":"textBody","style":"plain","value":"Library setups"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"I'm only using the major libraries for this app. Fortunately, some of them provide APIs for SSR setup. The common idea of libraries' SSR setup is getting the stringified part of each library from their API, then passing them into the HTML template."}]},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"React"}]},{"type":"paragraph","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"Document"}],"url":"https://reactjs.org/docs/react-dom-server.html#gatsby-focus-wrapper"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"React's API for SSR is "},{"type":"textBody","style":"code","value":"ReactDOMServer.renderToString(element)"},{"type":"textBody","style":"plain","value":". Pass the app in JSX format as the element parameter."}]},{"type":"code","lang":"ts","body":"import * as React from \"react\";\nimport * as ReactDOMServer from \"react-dom/server\";\n\nimport { App } from \"../client/App\";\n\nlet htmlBody;\n\ntry {\n  htmlBody = ReactDOMServer.renderToString(\u003cApp /\u003e);\n} catch (error) {\n  console.error(error);\n}"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"React Helmet"}]},{"type":"paragraph","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"Document"}],"url":"https://github.com/nfl/react-helmet#server-usage"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Helmet's API for SSR is "},{"type":"textBody","style":"code","value":"Helmet.renderStatic()"},{"type":"textBody","style":"plain","value":". You have to call it after "},{"type":"textBody","style":"code","value":"ReactDOMServer.renderToString"},{"type":"textBody","style":"plain","value":"."}]},{"type":"code","lang":"ts","body":"import { Helmet } from \"react-helmet\";\n\nlet htmlBody;\nlet helmet;\n\ntry {\n  htmlBody = ReactDOMServer.renderToString(\u003cApp /\u003e);\n  helmet = Helmet.renderStatic();\n} catch (error) {\n  console.error(error);\n}"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"React Router DOM"}]},{"type":"paragraph","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"Document"}],"url":"https://reactrouter.com/web/guides/server-rendering"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Wrap the app with a "},{"type":"textBody","style":"code","value":"StaticRouter"},{"type":"textBody","style":"plain","value":"."}]},{"type":"code","lang":"ts","body":"import { StaticRouter } from \"react-router-dom\";\n\nlet htmlBody;\nlet context;\n\napp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\ttry {\n\t\thtmlBody = ReactDOMServer.renderToString(\n\t\t\t\u003cStaticRouter location={req.url} context={context}\u003e\n\t\t\t\t\u003cApp /\u003e\n\t\t\t\u003c/StaticRouter\u003e\n\t\t);\n\t} catch(error) {\n\t\tconsole.error(error);\n\t}\n};"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"styled-components"}]},{"type":"paragraph","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"Document"}],"url":"https://styled-components.com/docs/advanced#server-side-rendering"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Use "},{"type":"textBody","style":"code","value":"sheet.collectStyles"},{"type":"textBody","style":"plain","value":" to wrap the app, then use "},{"type":"textBody","style":"code","value":"sheet.getStyleTags"},{"type":"textBody","style":"plain","value":" to collect all of the app's styles."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Finally, pass the styles into the HTML's head."}]},{"type":"code","lang":"ts","body":"import { ServerStyleSheet } from \"styled-components\";\n\nconst sheet = new ServerStyleSheet();\nlet htmlBody = \"\";\nlet styleTags = \"\";\n\ntry {\n  htmlBody = ReactDOMServer.renderToString(sheet.collectStyles(\u003cApp /\u003e));\n  styleTags = sheet.getStyleTags();\n} catch (error) {\n  console.error(error);\n} finally {\n  sheet.seal();\n}"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"Redux"}]},{"type":"paragraph","body":[{"type":"link","body":[{"type":"textBody","style":"plain","value":"Document"}],"url":"https://redux.js.org/recipes/server-rendering"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Redux's SSR setup is the most complex one. The contents of the store have to be prepared and passed to the HTML during the request."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"The way to prepare the store is different for each application. For my blog, I fetch the post or the post list data for the respective request URL, then convert the data to the store type."}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Once the store is prepared, wrap the app with a "},{"type":"textBody","style":"code","value":"Provider"},{"type":"textBody","style":"plain","value":", and get the "},{"type":"textBody","style":"code","value":"initialState"},{"type":"textBody","style":"plain","value":" with the API Redux provided."}]},{"type":"code","lang":"ts","body":"import { createStore } from \"redux\";\nimport { Provider } from \"react-redux\";\n\nimport { rootReducer, RootState } from \"../client/service/reducer\";\n\napp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\t// pass request because store is likely dependent on request URL\n\tconst yourStore = yourStoreInitiator(req);\n\tconst preloadedStore: RootState = {\n\t\t// your store state\n\t};\n\n\tlet htmlBody = \"\";\n\tconst store = createStore(rootReducer, preloadedState);\n\n\ttry {\n\t\thtmlBody = ReactDOMServer.renderToString(\n\t\t\t\u003cProvider store={store}\u003e\n\t\t\t\t\u003cApp /\u003e\n\t\t\t\u003c/Provider\u003e\n\t\t);\n\t} catch (error) {\n\t\tconsole.error(error);\n\t}\n\n\t// store.getState() returns object so we have to manually stringify it\n\tconst initialState = JSON.stringify(store.getState());\n};"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"HTML handler"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Since the HTML is frequently edited with several library parts, an isolated handler makes it easier."}]},{"type":"code","lang":"ts","body":"const getFullHTML = (\n  htmlBody: string,\n  styleTags: string,\n  initialState: string,\n  helmet?: HelmetData\n) =\u003e {\n  return `\n    \u003c!DOCTYPE html\u003e\n    \u003chtml ${helmet?.htmlAttributes.toString()}\u003e\n      \u003chead\u003e\n        \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\"\u003e\n        ${styleTags}\n        ${helmet?.title.toString()}\n        ${helmet?.meta.toString()}\n        ${helmet?.link.toString()}\n        \u003cstyle\u003e\n          @import url('\u003chttps://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900\u0026display=swap\u003e');\n          @import url('\u003chttps://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;400\u0026display=swap\u003e');\n        \u003c/style\u003e\n      \u003c/head\u003e\n      \u003cbody ${helmet?.bodyAttributes.toString()}\u003e\n        \u003cdiv id=\"app-root\"\u003e${htmlBody}\u003c/div\u003e\n        \u003cscript\u003ewindow.__INITIAL_STATE__ = ${initialState}\u003c/script\u003e\n        \u003cscript defer src=\"main.bundle.js\" type=\"text/javascript\" charset=\"utf-8\"\u003e\u003c/script\u003e\n        \u003cscript defer src=\"vendor.bundle.js\" type=\"text/javascript\" charset=\"utf-8\"\u003e\u003c/script\u003e\n      \u003c/body\u003e\n    \u003c/html\u003e\n  `;\n};"},{"type":"heading","level":2,"body":[{"type":"textBody","style":"plain","value":"Combine each part"}]},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"Finally, combine all of the setups above."}]},{"type":"code","lang":"ts","body":"import * as Express from \"express\";\nimport * as React from \"react\";\nimport * as ReactDOMServer from \"react-dom/server\";\nimport { Helmet, HelmetData } from \"react-helmet\";\nimport { Provider } from \"react-redux\";\nimport { StaticRouter } from \"react-router-dom\";\nimport { createStore } from \"redux\";\nimport { ServerStyleSheet } from \"styled-components\";\n\nimport { App } from \"../client/App\";\nimport { rootReducer, RootState } from \"../client/service/reducer\";\n\nexport const renderer = (\n\treq: Express.Request,\n\tres: Express.Response,\n\tnext: Express.NextFunction,\n) =\u003e {\n\tapp.get(\"*\", (req: Express.Request, res: Express.Response) =\u003e {\n\tconst yourStore = yourStoreInitiator(req);\n\tconst preloadedStore: RootState = { /* your state */ };\n\n\tlet htmlBody = \"\";\n\tconst context = {};\n  const sheet = new ServerStyleSheet();\n  let styleTags = \"\";\n\tconst store = createStore(rootReducer, preloadedState);\n\tlet helmet;\n\n\ttry {\n\t  htmlBody = ReactDOMServer.renderToString(\n      sheet.collectStyles(\n        \u003cProvider store={store}\u003e\n\t        \u003cStaticRouter location={req.url} context={context}\u003e\n            \u003cApp /\u003e\n\t        \u003c/StaticRouter\u003e\n        \u003c/Provider\u003e\n      )\n    );\n    helmet = Helmet.renderStatic();\n    styleTags = sheet.getStyleTags();\n  } catch (error) {\n    console.error(error);\n  } finally {\n    sheet.seal();\n  }\n  const initialState = JSON.stringify(store.getState());\n\n  const fullHTML = getFullHTML(htmlBody, styleTags, initialState, helmet);\n\tres.send(fullHTML);\n};"},{"type":"paragraph","body":[{"type":"textBody","style":"plain","value":"You can use "},{"type":"textBody","style":"code","value":"curl -X GET localhost:3000"},{"type":"textBody","style":"plain","value":" to check if the express server is returning the whole app in the first easily."}]}]}},"lastUpdated":"2025-10-04"}</script></head>
  <body>
    <div id="root"><div><div class="site_container grid"><header class="site-header"><div class="header-content"><div class="header_left_content"><nav><a href="/blog">blog</a><a href="/about">about</a><a href="/blog/feed.xml">rss</a></nav><button type="button" class="frontpage-header-menu-button">menu</button></div><h1><a href="/">ASUKA WANG</a></h1><div class="header_right_content"></div></div><div class="header-divider"></div></header><main class="grid"><div class="post-page-header_container"><a href="/blog/?category=retrospective">retrospective</a><h1>Refactor Blog: (2) SSR</h1><h2>After the Webpack setup for this site, I also implemented server-side-rendering from scratch.</h2><p>March 26, 2021</p></div><article class="post-page-content grid"><p>One of the reasons I choose Gatsby last time I wrote my blog site is to have SSR. SEO matters, isn&#x27;t it?</p><p>I gained experience setting up SSR in my job, and this is how I apply that experience in my project.</p><h1>The Idea</h1><p>First, let&#x27;s talk about React (and most of the MVVM frameworks) app without SSR. They are an HTML template with a js file. Everything about the app is in the js file; the HTML is merely a host for the app.</p><p>When the user&#x27;s browser requests data of the app from the server, the HTML is provided. A blank HTML page with some metadata is rendered.</p><p>Then the HTML requests the data of the js file from the <code>&lt;script&gt;</code> tag. The js file is fetched then executed. The logic inside starts working. Then the app is created and attached to a specific HTML element.</p><p>The problem is that search engines can&#x27;t observe the actual app in the first render. Therefore, for the search engines, the app is always a blank page.</p><p>The solution is SSR -- server-side rendering. When the app is requested, the server runs the app, prints them into strings, then sends them with the HTML. For the browsers or the search engines, they get the whole app in the first render.</p><h1>Dependencies</h1><ul><li><a href="http://expressjs.com/" target="_blank" rel="noopener noreferrer">express</a> for handling requests and responses</li></ul><h1>Setting up the server</h1><p>Receive requests and send HTML. The HTML will be a string instead of a file for inserting stringified app.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> Express</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">express</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">const</span><span style="color:#076678"> APP_PORT</span><span style="color:#427B58"> =</span><span style="color:#076678"> process</span><span style="color:#7C6F64">.</span><span style="color:#076678">env</span><span style="color:#7C6F64">.</span><span style="color:#076678">PORT</span><span style="color:#9D0006"> ||</span><span style="color:#8F3F71"> 3000</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">const</span><span style="color:#076678"> app</span><span style="color:#427B58"> =</span><span style="color:#B57614"> Express</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">const</span><span style="color:#B57614"> renderer</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ()</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">get</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">"</span><span style="color:#79740E">*</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">,</span><span style="color:#7C6F64"> (</span><span style="color:#076678">req</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Request</span><span style="color:#7C6F64">,</span><span style="color:#076678"> res</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Response</span><span style="color:#7C6F64">)</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">    res</span><span style="color:#7C6F64">.</span><span style="color:#B57614">send</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">`</span></span>
<span class="line"><span style="color:#79740E">			&#x3C;!DOCTYPE HTML></span></span>
<span class="line"><span style="color:#79740E">			&#x3C;html></span></span>
<span class="line"><span style="color:#79740E">				&#x3C;head></span></span>
<span class="line"><span style="color:#79740E">					&#x3C;!-- insert metadata here --></span></span>
<span class="line"><span style="color:#79740E">				&#x3C;/head></span></span>
<span class="line"><span style="color:#79740E">				&#x3C;body></span></span>
<span class="line"><span style="color:#79740E">					&#x3C;div id="app-root">&#x3C;/div></span></span>
<span class="line"><span style="color:#79740E">				&#x3C;/body></span></span>
<span class="line"><span style="color:#79740E">			&#x3C;/html></span></span>
<span class="line"><span style="color:#7C6F64">		`</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">  }</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#076678">app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">use</span><span style="color:#3C3836">(</span><span style="color:#076678">renderer</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">listen</span><span style="color:#3C3836">(</span><span style="color:#076678">APP_PORT</span><span style="color:#7C6F64">,</span><span style="color:#7C6F64"> ()</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">log</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">`</span><span style="color:#79740E">Server is listening on </span><span style="color:#7C6F64">${</span><span style="color:#076678">APP_PORT</span><span style="color:#7C6F64">}`</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span></code></pre></div><h1>Library setups</h1><p>I&#x27;m only using the major libraries for this app. Fortunately, some of them provide APIs for SSR setup. The common idea of libraries&#x27; SSR setup is getting the stringified part of each library from their API, then passing them into the HTML template.</p><h2>React</h2><p><a href="https://reactjs.org/docs/react-dom-server.html#gatsby-focus-wrapper" target="_blank" rel="noopener noreferrer">Document</a></p><p>React&#x27;s API for SSR is <code>ReactDOMServer.renderToString(element)</code>. Pass the app in JSX format as the element parameter.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> React</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-dom/server</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> App</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">../client/App</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> htmlBody</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(&#x3C;</span><span style="color:#B57614">App</span><span style="color:#3C3836"> />)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836"> (</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">  console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span></span></code></pre></div><h2>React Helmet</h2><p><a href="https://github.com/nfl/react-helmet#server-usage" target="_blank" rel="noopener noreferrer">Document</a></p><p>Helmet&#x27;s API for SSR is <code>Helmet.renderStatic()</code>. You have to call it after <code>ReactDOMServer.renderToString</code>.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> Helmet</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-helmet</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> htmlBody</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> helmet</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(&#x3C;</span><span style="color:#B57614">App</span><span style="color:#3C3836"> />)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">  helmet</span><span style="color:#427B58"> =</span><span style="color:#076678"> Helmet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderStatic</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836"> (</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">  console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span></span></code></pre></div><h2>React Router DOM</h2><p><a href="https://reactrouter.com/web/guides/server-rendering" target="_blank" rel="noopener noreferrer">Document</a></p><p>Wrap the app with a <code>StaticRouter</code>.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> StaticRouter</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-router-dom</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> htmlBody</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> context</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#076678">app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">get</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">"</span><span style="color:#79740E">*</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">,</span><span style="color:#7C6F64"> (</span><span style="color:#076678">req</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Request</span><span style="color:#7C6F64">,</span><span style="color:#076678"> res</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Response</span><span style="color:#7C6F64">)</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#9D0006">	try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">		htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(</span></span>
<span class="line"><span style="color:#427B58">			&#x3C;</span><span style="color:#076678">StaticRouter</span><span style="color:#076678"> location</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#3C3836">req.</span><span style="color:#076678">url</span><span style="color:#7C6F64">}</span><span style="color:#076678"> context</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#076678">context</span><span style="color:#7C6F64">}</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#427B58">				&#x3C;</span><span style="color:#076678">App</span><span style="color:#427B58"> /></span></span>
<span class="line"><span style="color:#427B58">			&#x3C;/</span><span style="color:#076678">StaticRouter</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#3C3836">		)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">	}</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">		console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">	}</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#3C3836">;</span></span></code></pre></div><h2>styled-components</h2><p><a href="https://styled-components.com/docs/advanced#server-side-rendering" target="_blank" rel="noopener noreferrer">Document</a></p><p>Use <code>sheet.collectStyles</code> to wrap the app, then use <code>sheet.getStyleTags</code> to collect all of the app&#x27;s styles.</p><p>Finally, pass the styles into the HTML&#x27;s head.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> ServerStyleSheet</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">styled-components</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">const</span><span style="color:#076678"> sheet</span><span style="color:#427B58"> =</span><span style="color:#AF3A03"> new</span><span style="color:#B57614"> ServerStyleSheet</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> htmlBody</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ""</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">let</span><span style="color:#076678"> styleTags</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ""</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(</span><span style="color:#076678">sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">collectStyles</span><span style="color:#3C3836">(&#x3C;</span><span style="color:#B57614">App</span><span style="color:#3C3836"> />))</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">  styleTags</span><span style="color:#427B58"> =</span><span style="color:#076678"> sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">getStyleTags</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836"> (</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">  console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#9D0006"> finally</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">  sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">seal</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span></span></code></pre></div><h2>Redux</h2><p><a href="https://redux.js.org/recipes/server-rendering" target="_blank" rel="noopener noreferrer">Document</a></p><p>Redux&#x27;s SSR setup is the most complex one. The contents of the store have to be prepared and passed to the HTML during the request.</p><p>The way to prepare the store is different for each application. For my blog, I fetch the post or the post list data for the respective request URL, then convert the data to the store type.</p><p>Once the store is prepared, wrap the app with a <code>Provider</code>, and get the <code>initialState</code> with the API Redux provided.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> createStore</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">redux</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> Provider</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-redux</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> rootReducer</span><span style="color:#7C6F64">,</span><span style="color:#076678"> RootState</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">../client/service/reducer</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#076678">app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">get</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">"</span><span style="color:#79740E">*</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">,</span><span style="color:#7C6F64"> (</span><span style="color:#076678">req</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Request</span><span style="color:#7C6F64">,</span><span style="color:#076678"> res</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Response</span><span style="color:#7C6F64">)</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#928374;font-style:italic">	// pass request because store is likely dependent on request URL</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> yourStore</span><span style="color:#427B58"> =</span><span style="color:#B57614"> yourStoreInitiator</span><span style="color:#3C3836">(</span><span style="color:#076678">req</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> preloadedStore</span><span style="color:#427B58">:</span><span style="color:#B57614"> RootState </span><span style="color:#427B58">=</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#928374;font-style:italic">		// your store state</span></span>
<span class="line"><span style="color:#7C6F64">	};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">	let</span><span style="color:#076678"> htmlBody</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ""</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> store</span><span style="color:#427B58"> =</span><span style="color:#B57614"> createStore</span><span style="color:#3C3836">(</span><span style="color:#076678">rootReducer</span><span style="color:#7C6F64">,</span><span style="color:#076678"> preloadedState</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">	try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">		htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(</span></span>
<span class="line"><span style="color:#427B58">			&#x3C;</span><span style="color:#076678">Provider</span><span style="color:#076678"> store</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#076678">store</span><span style="color:#7C6F64">}</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#427B58">				&#x3C;</span><span style="color:#076678">App</span><span style="color:#427B58"> /></span></span>
<span class="line"><span style="color:#427B58">			&#x3C;/</span><span style="color:#076678">Provider</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#3C3836">		)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">	}</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836"> (</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">		console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#928374;font-style:italic">	// store.getState() returns object so we have to manually stringify it</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> initialState</span><span style="color:#427B58"> =</span><span style="color:#076678"> JSON</span><span style="color:#7C6F64">.</span><span style="color:#B57614">stringify</span><span style="color:#3C3836">(</span><span style="color:#076678">store</span><span style="color:#7C6F64">.</span><span style="color:#B57614">getState</span><span style="color:#3C3836">())</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#3C3836">;</span></span></code></pre></div><h2>HTML handler</h2><p>Since the HTML is frequently edited with several library parts, an isolated handler makes it easier.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#AF3A03">const</span><span style="color:#B57614"> getFullHTML</span><span style="color:#427B58"> =</span><span style="color:#3C3836"> (</span></span>
<span class="line"><span style="color:#076678">  htmlBody</span><span style="color:#427B58">:</span><span style="color:#B57614"> string</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#076678">  styleTags</span><span style="color:#427B58">:</span><span style="color:#B57614"> string</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#076678">  initialState</span><span style="color:#427B58">:</span><span style="color:#B57614"> string</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#076678">  helmet</span><span style="color:#427B58">?:</span><span style="color:#B57614"> HelmetData</span></span>
<span class="line"><span style="color:#3C3836">) </span><span style="color:#AF3A03">=></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#9D0006">  return</span><span style="color:#7C6F64"> `</span></span>
<span class="line"><span style="color:#79740E">    &#x3C;!DOCTYPE html></span></span>
<span class="line"><span style="color:#79740E">    &#x3C;html </span><span style="color:#7C6F64">${</span><span style="color:#076678">helmet</span><span style="color:#7C6F64">?.</span><span style="color:#076678">htmlAttributes</span><span style="color:#7C6F64">.</span><span style="color:#B57614">toString</span><span style="color:#79740E">()</span><span style="color:#7C6F64">}</span><span style="color:#79740E">></span></span>
<span class="line"><span style="color:#79740E">      &#x3C;head></span></span>
<span class="line"><span style="color:#79740E">        &#x3C;meta name="viewport" content="width=device-width, initial-scale=1"></span></span>
<span class="line"><span style="color:#7C6F64">        ${</span><span style="color:#076678">styleTags</span><span style="color:#7C6F64">}</span></span>
<span class="line"><span style="color:#7C6F64">        ${</span><span style="color:#076678">helmet</span><span style="color:#7C6F64">?.</span><span style="color:#076678">title</span><span style="color:#7C6F64">.</span><span style="color:#B57614">toString</span><span style="color:#79740E">()</span><span style="color:#7C6F64">}</span></span>
<span class="line"><span style="color:#7C6F64">        ${</span><span style="color:#076678">helmet</span><span style="color:#7C6F64">?.</span><span style="color:#076678">meta</span><span style="color:#7C6F64">.</span><span style="color:#B57614">toString</span><span style="color:#79740E">()</span><span style="color:#7C6F64">}</span></span>
<span class="line"><span style="color:#7C6F64">        ${</span><span style="color:#076678">helmet</span><span style="color:#7C6F64">?.</span><span style="color:#076678">link</span><span style="color:#7C6F64">.</span><span style="color:#B57614">toString</span><span style="color:#79740E">()</span><span style="color:#7C6F64">}</span></span>
<span class="line"><span style="color:#79740E">        &#x3C;style></span></span>
<span class="line"><span style="color:#79740E">          @import url('&#x3C;https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&#x26;display=swap>');</span></span>
<span class="line"><span style="color:#79740E">          @import url('&#x3C;https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;400&#x26;display=swap>');</span></span>
<span class="line"><span style="color:#79740E">        &#x3C;/style></span></span>
<span class="line"><span style="color:#79740E">      &#x3C;/head></span></span>
<span class="line"><span style="color:#79740E">      &#x3C;body </span><span style="color:#7C6F64">${</span><span style="color:#076678">helmet</span><span style="color:#7C6F64">?.</span><span style="color:#076678">bodyAttributes</span><span style="color:#7C6F64">.</span><span style="color:#B57614">toString</span><span style="color:#79740E">()</span><span style="color:#7C6F64">}</span><span style="color:#79740E">></span></span>
<span class="line"><span style="color:#79740E">        &#x3C;div id="app-root"></span><span style="color:#7C6F64">${</span><span style="color:#076678">htmlBody</span><span style="color:#7C6F64">}</span><span style="color:#79740E">&#x3C;/div></span></span>
<span class="line"><span style="color:#79740E">        &#x3C;script>window.__INITIAL_STATE__ = </span><span style="color:#7C6F64">${</span><span style="color:#076678">initialState</span><span style="color:#7C6F64">}</span><span style="color:#79740E">&#x3C;/script></span></span>
<span class="line"><span style="color:#79740E">        &#x3C;script defer src="main.bundle.js" type="text/javascript" charset="utf-8">&#x3C;/script></span></span>
<span class="line"><span style="color:#79740E">        &#x3C;script defer src="vendor.bundle.js" type="text/javascript" charset="utf-8">&#x3C;/script></span></span>
<span class="line"><span style="color:#79740E">      &#x3C;/body></span></span>
<span class="line"><span style="color:#79740E">    &#x3C;/html></span></span>
<span class="line"><span style="color:#7C6F64">  `</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">};</span></span></code></pre></div><h2>Combine each part</h2><p>Finally, combine all of the setups above.</p><div><pre class="shiki gruvbox-light-soft" style="background-color:#f2e5bc;color:#3c3836" tabindex="0"><code><span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> Express</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">express</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> React</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#8F3F71"> *</span><span style="color:#9D0006"> as</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-dom/server</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> Helmet</span><span style="color:#7C6F64">,</span><span style="color:#076678"> HelmetData</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-helmet</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> Provider</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-redux</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> StaticRouter</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">react-router-dom</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> createStore</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">redux</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> ServerStyleSheet</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">styled-components</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> App</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">../client/App</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#9D0006">import</span><span style="color:#7C6F64"> {</span><span style="color:#076678"> rootReducer</span><span style="color:#7C6F64">,</span><span style="color:#076678"> RootState</span><span style="color:#7C6F64"> }</span><span style="color:#9D0006"> from</span><span style="color:#7C6F64"> "</span><span style="color:#79740E">../client/service/reducer</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">export</span><span style="color:#AF3A03"> const</span><span style="color:#B57614"> renderer</span><span style="color:#427B58"> =</span><span style="color:#3C3836"> (</span></span>
<span class="line"><span style="color:#076678">	req</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Request</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#076678">	res</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Response</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#076678">	next</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">NextFunction</span><span style="color:#7C6F64">,</span></span>
<span class="line"><span style="color:#3C3836">) </span><span style="color:#AF3A03">=></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">	app</span><span style="color:#7C6F64">.</span><span style="color:#B57614">get</span><span style="color:#3C3836">(</span><span style="color:#7C6F64">"</span><span style="color:#79740E">*</span><span style="color:#7C6F64">"</span><span style="color:#7C6F64">,</span><span style="color:#7C6F64"> (</span><span style="color:#076678">req</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Request</span><span style="color:#7C6F64">,</span><span style="color:#076678"> res</span><span style="color:#427B58">:</span><span style="color:#B57614"> Express</span><span style="color:#7C6F64">.</span><span style="color:#B57614">Response</span><span style="color:#7C6F64">)</span><span style="color:#AF3A03"> =></span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> yourStore</span><span style="color:#427B58"> =</span><span style="color:#B57614"> yourStoreInitiator</span><span style="color:#3C3836">(</span><span style="color:#076678">req</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> preloadedStore</span><span style="color:#427B58">:</span><span style="color:#B57614"> RootState </span><span style="color:#427B58">=</span><span style="color:#7C6F64"> {</span><span style="color:#928374;font-style:italic"> /* your state */</span><span style="color:#7C6F64"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">	let</span><span style="color:#076678"> htmlBody</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ""</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> context</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> {};</span></span>
<span class="line"><span style="color:#AF3A03">  const</span><span style="color:#076678"> sheet</span><span style="color:#427B58"> =</span><span style="color:#AF3A03"> new</span><span style="color:#B57614"> ServerStyleSheet</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">  let</span><span style="color:#076678"> styleTags</span><span style="color:#427B58"> =</span><span style="color:#7C6F64"> ""</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	const</span><span style="color:#076678"> store</span><span style="color:#427B58"> =</span><span style="color:#B57614"> createStore</span><span style="color:#3C3836">(</span><span style="color:#076678">rootReducer</span><span style="color:#7C6F64">,</span><span style="color:#076678"> preloadedState</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#AF3A03">	let</span><span style="color:#076678"> helmet</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9D0006">	try</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">	  htmlBody</span><span style="color:#427B58"> =</span><span style="color:#076678"> ReactDOMServer</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderToString</span><span style="color:#3C3836">(</span></span>
<span class="line"><span style="color:#076678">      sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">collectStyles</span><span style="color:#3C3836">(</span></span>
<span class="line"><span style="color:#427B58">        &#x3C;</span><span style="color:#076678">Provider</span><span style="color:#076678"> store</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#076678">store</span><span style="color:#7C6F64">}</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#427B58">	        &#x3C;</span><span style="color:#076678">StaticRouter</span><span style="color:#076678"> location</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#3C3836">req.</span><span style="color:#076678">url</span><span style="color:#7C6F64">}</span><span style="color:#076678"> context</span><span style="color:#427B58">=</span><span style="color:#7C6F64">{</span><span style="color:#076678">context</span><span style="color:#7C6F64">}</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#427B58">            &#x3C;</span><span style="color:#076678">App</span><span style="color:#427B58"> /></span></span>
<span class="line"><span style="color:#427B58">	        &#x3C;/</span><span style="color:#076678">StaticRouter</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#427B58">        &#x3C;/</span><span style="color:#076678">Provider</span><span style="color:#427B58">></span></span>
<span class="line"><span style="color:#3C3836">      )</span></span>
<span class="line"><span style="color:#3C3836">    )</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">    helmet</span><span style="color:#427B58"> =</span><span style="color:#076678"> Helmet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">renderStatic</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">    styleTags</span><span style="color:#427B58"> =</span><span style="color:#076678"> sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">getStyleTags</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">  }</span><span style="color:#9D0006"> catch</span><span style="color:#3C3836"> (</span><span style="color:#076678">error</span><span style="color:#3C3836">) </span><span style="color:#7C6F64">{</span></span>
<span class="line"><span style="color:#076678">    console</span><span style="color:#7C6F64">.</span><span style="color:#B57614">error</span><span style="color:#3C3836">(</span><span style="color:#076678">error</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">  }</span><span style="color:#9D0006"> finally</span><span style="color:#7C6F64"> {</span></span>
<span class="line"><span style="color:#076678">    sheet</span><span style="color:#7C6F64">.</span><span style="color:#B57614">seal</span><span style="color:#3C3836">()</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">  }</span></span>
<span class="line"><span style="color:#AF3A03">  const</span><span style="color:#076678"> initialState</span><span style="color:#427B58"> =</span><span style="color:#076678"> JSON</span><span style="color:#7C6F64">.</span><span style="color:#B57614">stringify</span><span style="color:#3C3836">(</span><span style="color:#076678">store</span><span style="color:#7C6F64">.</span><span style="color:#B57614">getState</span><span style="color:#3C3836">())</span><span style="color:#7C6F64">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AF3A03">  const</span><span style="color:#076678"> fullHTML</span><span style="color:#427B58"> =</span><span style="color:#B57614"> getFullHTML</span><span style="color:#3C3836">(</span><span style="color:#076678">htmlBody</span><span style="color:#7C6F64">,</span><span style="color:#076678"> styleTags</span><span style="color:#7C6F64">,</span><span style="color:#076678"> initialState</span><span style="color:#7C6F64">,</span><span style="color:#076678"> helmet</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#076678">	res</span><span style="color:#7C6F64">.</span><span style="color:#B57614">send</span><span style="color:#3C3836">(</span><span style="color:#076678">fullHTML</span><span style="color:#3C3836">)</span><span style="color:#7C6F64">;</span></span>
<span class="line"><span style="color:#7C6F64">}</span><span style="color:#3C3836">;</span></span></code></pre></div><p>You can use <code>curl -X GET localhost:3000</code> to check if the express server is returning the whole app in the first easily.</p></article></main><footer class="site-footer_container">Asuka Wang © <!-- -->2025</footer></div></div></div>
  </body>
</html>
